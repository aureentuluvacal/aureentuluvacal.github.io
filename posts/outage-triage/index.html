<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<link rel="icon" href="../../favicon.ico" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
		rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<!-- Katex -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"
		integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">

	
		<link href="../../_app/immutable/assets/0.0aUjidVN.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/3.jv80lpkj.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.Ov-9iytD.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/main-client.0o2Jgazd.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/runtime.n4xba1mo.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/singletons.sXjjn1Co.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/paths.H21PiljT.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.4iiOYp7d.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/preload-helper.0HuHagjb.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/disclose-version.kKvJJDcG.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.05hzbzow.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/3.A0pRLW15.js"><title>How I caused another outage</title><!--ssr:0--><!--ssr:0-->
</head>

<body data-sveltekit-preload-data="hover">
	<div style="display: contents">
		<div id="header-container">
			<h1>Cal Perez</h1>
			<p>
				Senior Software Engineer. I also like to cook, paint, and play D&D and
				Warhammer RPG.
			</p>
		</div>
		<div id="content-container">
			<!--ssr:0--><!--ssr:1--><!--ssr:if:true--><!--ssr:3--><div class="container"><!--ssr:4--><!--ssr:5--><div><article class="svelte-k80i5u"><header><h1>How I caused another outage</h1> <!--ssr:6--><!--ssr:if:false--><!--ssr:6--> <h5>July 18, 2020</h5></header> <div id="post-content" class="svelte-k80i5u"><!--ssr:7--><div><!--ssr:10-->
<p>We haven't had an outage at Iris in like 8 months. I guess it was just a matter of time before it happened again, but I thought I'd have the necessary foresight to not introduce code into master that exposes database flaws.</p>
<p>Oh well. I learned what I have to do, so when it does happen again, it won't feel so fan shit hitty.</p>
<p>Now...database flaws, what does that mean? If you've guessed an unindexed table, you'd be correct! ðŸŽ‰</p>
<p>Regrettably, I made a noob mistake merging a database migration adding an index to a beefy table and the code that required the migration to work effectively in the same release. I should have released the migration first then the feature after the table was done indexing in production. But it turns out, that wasn't the direct cause of the outage.</p>
<p>The migration just didn't even run during the deployment in Kubernetes and it took me too long to realize that fact. I noticed the failed pod, looked at the logs, and realized the <code>rails db:migrate</code> process errored out on some faulty data.</p>
<blockquote>
<p>This is totally an aside, but if you ever see an error during a migration that adds a foreign key, check the table you're trying to add the foreign key to for orphaned rows. Can't add a key to something that doesn't exist.</p>
</blockquote>
<p>After I fixed the data, the migrations ran. The index completed in 10 minutes and the app started working again because the database wasn't overloaded with slow ass queries. In the aftermath I harnessed the leftover anger I had towards myself (fueled by the thought, &quot;I'm the CTO, I should know better&quot;) and cranked out a new outage contingency plan.</p>
<h2>The new plan</h2>
<p>Our plan is composed of three steps:</p>
<ol>
<li>Diagnosis</li>
<li>Reverting master</li>
<li>Make the fix.</li>
</ol>
<h3>Diagnosis</h3>
<p>This step should take less than 20 minutes because it's about identifying the fix, not actually fixing it. I laid out common sources of outages after a release, including the code itself, the code exposing a database flaw, and a deployment failure.</p>
<p>We use Rollbar to track 4XX and 5XX errors, so finding the tracked issue that relates to a code issue is easy. The fix inherently could be more complicated because the faulty code could be anywhere.</p>
<p>If there's no obvious sign in Rollbar of a code issue, then the next thing to check is RDS in AWS for high CPU usage. When I looked at RDS during this last outage, CPU usage would spike intermittently. Running <code>SHOW PROCESSLIST;</code> within the instance proved that an index was missing because so many threads were stuck on the same query.</p>
<p>The last source to check is the Kubernetes deployment. The logs for our <code>deploy-tasks</code> pod were pretty clear about the error that occurred during the migration.</p>
<h3>Revert master</h3>
<p>This step should have happened within the first 15-20 minutes of us noticing the outage. Instead, I focused my energy on finding the fix for a source I had yet to find because I looked at Kubernetes last and caused the app to be down for way longer than it should have been.</p>
<p><img src="https://media.giphy.com/media/X7jENDat6V5Je/giphy.gif" alt="image"></p>
<p>At least this is the easiest step.</p>
<h3>Make the fix</h3>
<p>The actual fix can vary in complexity depending on if it's an actual code issue that's the source of the outage. This makes sense since the codebase is so large; some areas you don't want to touch and some of the newer areas are pleasant because <em>you</em> wrote them.</p>
<p>Database and deployment issues are easier to fix, in my opinion, because the former requires a migration while the latter requires you to fix errors that occur during a single command (<code>rails db:migrate</code>).</p>
<blockquote>
<p>I covered how to add a new index asynchronously in <a href="https://caryssaperez.com/troubleshooting-db-cpu-error">Troubleshooting Rails Database Connection Issue</a>.</p>
</blockquote>
<h2>Going forward</h2>
<p>This process is definitely a living document so I can record different fixes for different causes of the outage. It's also good to have for my two other engineers to reference in case I'm incapacitated or otherwise unavailable.</p>
<p>Hopefully, I can minimize the noob mistakes.</p>
<!--ssr:10--></div><!--ssr:7--></div> <div class="post-controlContainer"><!--ssr:8--><!--ssr:if:true--><a href="../../posts/logic-part-2" target="_self" class="post-control svelte-k80i5u"><p class="svelte-k80i5u"><i class="icons-arrow icons-arrow--left svelte-k80i5u"></i> Previous</p> <p class="svelte-k80i5u">2 Logic 2 Furious</p></a><!--ssr:8--> <!--ssr:9--><!--ssr:if:true--><a href="../../posts/warhammer-first-army" target="_self" class="post-control svelte-k80i5u" style="text-align: right;"><p class="svelte-k80i5u">Next <i class="icons-arrow icons-arrow--right svelte-k80i5u"></i></p> <p class="svelte-k80i5u">Finished my first, almost 500 point army!</p></a><!--ssr:9--></div></article></div><!--ssr:5--><!--ssr:4--></div><!--ssr:3--><!--ssr:1--> <!--ssr:2--><!--ssr:if:false--><!--ssr:2--><!--ssr:0-->
			
			<script>
				{
					__sveltekit_1onsyu0 = {
						base: new URL("../..", location).pathname.slice(0, -1),
						env: null
					};

					const element = document.currentScript.parentElement;

					const data = [null,{"type":"data","data":{post:{title:"How I caused another outage",date:"2020-07-19T00:00:00.000Z",description:"And the new process I'll be using going forward.",tags:["Code"],slug:"outage-triage",next:{title:"Finished my first, almost 500 point army!",date:"2020-07-26T00:00:00.000Z",description:"Got into Warhammer 40k during the quarantine and I've been hooked ever since. RIP bank account.",tags:["Personal"],slug:"warhammer-first-army"},previous:{title:"2 Logic 2 Furious",description:"More complicated propositional logic!",date:"2020-07-18T00:00:00.000Z",tags:["Math"],slug:"logic-part-2"}}},"uses":{"params":["slug"]}}];

					Promise.all([
						import("../../_app/immutable/entry/start.Ov-9iytD.js"),
						import("../../_app/immutable/entry/app.4iiOYp7d.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		
		</div>
	</div>
</body>

</html>
